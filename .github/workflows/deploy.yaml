name: deploy

on:
    push:
        branches:
            - main
    workflow_dispatch:
  

jobs:
    deploy:
        runs-on: ubuntu-latest
        env:
            SSH_AUTH_SOCK: /tmp/ssh_agent.sock

        steps:
        - uses: actions/checkout@v3
        
        - name: Install dependencies
          run: npm ci

        - name: Build website
          run: npm run build

        - name: Add SSH key
          run: |
            mkdir -p ~/.ssh/
            ssh-keyscan ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-agent -a $SSH_AUTH_SOCK > /dev/null
            ssh-add ~/.ssh/id_rsa

        - name: Deploy to Contabo
          run: |
            scp -r ./dist ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_PATH }}
